name: Deploy Student App to GCP

on:
  push:
    branches: [ main ]

jobs:
  generate-keys:
    runs-on: ubuntu-latest
    outputs:
      ssh_private_key: ${{ steps.generate-keys.outputs.private_key }}
      ssh_public_key: ${{ steps.generate-keys.outputs.public_key }}
    steps:
      - name: Generate SSH Key Pair
        id: generate-keys
        run: |
          ssh-keygen -t rsa -b 4096 -f ./ssh_key -N "" -q
          echo "private_key<<EOF" >> $GITHUB_OUTPUT
          cat ./ssh_key >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "public_key<<EOF" >> $GITHUB_OUTPUT
          cat ./ssh_key.pub >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  terraform-deploy:
    runs-on: ubuntu-latest
    needs: generate-keys
    steps:
      - uses: actions/checkout@v3
      
      - name: Configure GCP Credentials
        run: |
          echo "${{ secrets.GCP_CREDENTIALS }}" > gcp-creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-creds.json" >> $GITHUB_ENV
          gcloud auth activate-service-account --key-file=gcp-creds.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      - name: Save SSH Keys
        run: |
          echo '${{ needs.generate-keys.outputs.ssh_public_key }}' > ssh_key.pub
          echo '${{ needs.generate-keys.outputs.ssh_private_key }}' > ssh_key
          chmod 600 ssh_key

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'

      - name: Terraform Apply
        working-directory: ./terraform
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          terraform init
          terraform apply -auto-approve \
            -var="gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="ssh_pub_key_file=../ssh_key.pub"

      - name: Get VM IP
        id: get-ip
        working-directory: ./terraform
        run: |
          VM_IP=$(terraform output -raw vm_public_ip)
          echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT

      - name: Deploy Application
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo '${{ needs.generate-keys.outputs.ssh_private_key }}' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.get-ip.outputs.vm_ip }} >> ~/.ssh/known_hosts 2>/dev/null
          
          # Simple deployment commands
          ssh -o StrictHostKeyChecking=no ubuntu@${{ steps.get-ip.outputs.vm_ip }} "
          sudo apt-get update -y
          sudo apt-get install -y docker.io
          sudo systemctl enable docker
          sudo systemctl start docker
          sudo usermod -aG docker ubuntu
          
          # Pull and run your Docker image
          sudo docker run -d \
            --name student-app \
            -p 9393:9393 \
            --restart unless-stopped \
            ${{ secrets.DOCKER_USERNAME }}/student-app:latest
          "
          
      - name: Verify Deployment
        run: |
          sleep 10
          curl -f http://${{ steps.get-ip.outputs.vm_ip }}:9393/api/health || echo "Health check failed"