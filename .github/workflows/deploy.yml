name: Deploy Student App to GCP

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
  DOCKER_IMAGE: student-app:latest

jobs:
  generate-ssh-key:
    runs-on: ubuntu-latest
    outputs:
      private_key: ${{ steps.generate-key.outputs.private_key }}
      public_key: ${{ steps.generate-key.outputs.public_key }}
    steps:
      - name: Generate SSH Key Pair
        id: generate-key
        run: |
          ssh-keygen -t rsa -b 4096 -f ./id_rsa -N "" -q
          echo "private_key<<EOF" >> $GITHUB_OUTPUT
          cat ./id_rsa >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "public_key<<EOF" >> $GITHUB_OUTPUT
          cat ./id_rsa.pub >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          cd src
          npm ci
          
      - name: Test application
        run: |
          cd src
          echo "Testing student app..."
          node -e "console.log('Node.js test passed')"
          
  build:
    runs-on: ubuntu-latest
    needs: [test, generate-ssh-key]
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Login to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
          
      - name: Build Docker image
        run: |
          cd src
          docker build -t student-app:latest .
          
      - name: Push to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker tag student-app:latest ${{ secrets.DOCKER_USERNAME }}/student-app:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/student-app:latest
          
  terraform-plan:
    runs-on: ubuntu-latest
    needs: [build, generate-ssh-key]
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'
          
      - name: Configure GCP credentials
        run: |
          echo "${{ secrets.GCP_CREDENTIALS }}" > gcp-creds.json
          
      - name: Save SSH Public Key
        run: |
          echo '${{ needs.generate-ssh-key.outputs.public_key }}' > ssh_key.pub
          echo 'SSH Public Key:'
          cat ssh_key.pub
          
      - name: Save SSH Private Key
        run: |
          echo '${{ needs.generate-ssh-key.outputs.private_key }}' > ssh_key
          chmod 600 ssh_key
          
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init
        
      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="gcp_credentials_file=../gcp-creds.json" \
            -var="ssh_pub_key_file=../ssh_key.pub" \
            -var="ssh_private_key_file=../ssh_key"
            
  terraform-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'
          
      - name: Configure GCP credentials
        run: |
          echo "${{ secrets.GCP_CREDENTIALS }}" > gcp-creds.json
          
      - name: Save SSH Public Key
        run: |
          echo '${{ needs.generate-ssh-key.outputs.public_key }}' > ssh_key.pub
          
      - name: Save SSH Private Key
        run: |
          echo '${{ needs.generate-ssh-key.outputs.private_key }}' > ssh_key
          chmod 600 ssh_key
          
      - name: Terraform Apply
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve \
            -var="gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="gcp_credentials_file=../gcp-creds.json" \
            -var="ssh_pub_key_file=../ssh_key.pub" \
            -var="ssh_private_key_file=../ssh_key"
            
  deploy-app:
    runs-on: ubuntu-latest
    needs: [terraform-apply, generate-ssh-key]
    steps:
      - uses: actions/checkout@v3
      
      - name: Get VM IP
        id: get-ip
        run: |
          cd terraform
          IP=$(terraform output -raw vm_public_ip)
          echo "vm_ip=$IP" >> $GITHUB_OUTPUT
          echo "VM Public IP: $IP"
          
      - name: Setup SSH Connection
        run: |
          mkdir -p ~/.ssh
          echo '${{ needs.generate-ssh-key.outputs.private_key }}' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.get-ip.outputs.vm_ip }} >> ~/.ssh/known_hosts
          
      - name: Deploy Application
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@${{ steps.get-ip.outputs.vm_ip }} << 'EOF'
          echo "=== Deploying Student App ==="
          
          # Update system
          sudo apt-get update -y
          
          # Install Docker
          sudo apt-get install -y docker.io
          sudo systemctl enable docker
          sudo systemctl start docker
          sudo usermod -aG docker ubuntu
          
          # Run Docker container
          sudo docker stop student-app || true
          sudo docker rm student-app || true
          sudo docker run -d \
            --name student-app \
            -p 9393:9393 \
            --restart always \
            ${{ secrets.DOCKER_USERNAME }}/student-app:latest
          
          echo "âœ… Application deployed!"
          EOF
          
      - name: Test Deployment
        run: |
          echo "Waiting for application to start..."
          sleep 15
          echo "Testing health endpoint..."
          curl -f http://${{ steps.get-ip.outputs.vm_ip }}:9393/api/health || exit 1
          
      - name: Display Deployment Info
        run: |
          echo "========================================"
          echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
          echo "========================================"
          echo ""
          echo "ðŸŒ Application URL:"
          echo "   http://${{ steps.get-ip.outputs.vm_ip }}:9393"
          echo ""
          echo "ðŸ”— Health Check:"
          echo "   http://${{ steps.get-ip.outputs.vm_ip }}:9393/api/health"
          echo ""
          echo "ðŸ“Š API Endpoints:"
          echo "   GET    /api/students"
          echo "   POST   /api/students"
          echo "   GET    /api/students/{id}"
          echo "   PUT    /api/students/{id}"
          echo "   DELETE /api/students/{id}"
          echo ""
          echo "========================================"